{% extends "base.html" %}
{% block title %}{{product.name}} {% endblock title %}
{% block body %}

<main class="main">

    <div class="mb-30 container">
        <div class="row">
            <div class="col-lg-12 col-xl-11 m-auto">
                <div class="row">
                    <div class="col-xl-9">
                        <div class="accordion-detail product-detail">
                            <div class="mt-30 mb-50 row">
                                <div class="mb-md-0 mb-sm-5 col-md-6 col-xl-9 col-xs-12">
                                    <div class="">
                                        <!-- MAIN SLIDES -->
                                        <div class="">
                                            <div class="border-radius-10">
                                                <img
                                                    src="{{product.image.url}}"
                                                    alt="product image"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                    <!-- End Gallery -->
                                </div>
                                <h2 class="title-detail text-3xl font-bold">{{product.name}}</h2>
                                <div class="product-price-cover clearfix">
                                    <div class="primary-color product-price float-left">
                                        <h3> <span
                                                class="text-brand current-price text-2xl font-semibold">{{product.price}}
                                                €
                                            </span>
                                        </h3>
                                    </div>
                                </div>
                            </div>
                            <!-- <input
                                    type="hidden"
                                    name="product"
                                    value="{{product.id}}"
                                    id="{{product.id}}"
                                > -->
                            <!-- <div class="card col-xl-9 p-5">
                                    <h5 class="mb-30 text-3xl">Variation</h5>
                                    {% for variation in product.variations.all %}
                                    <div class="d-flex">
                                        <div class="mr-80 custome-checkbox">
                                            <input
                                                class="form-check-input"
                                                type="checkbox"
                                                id="{{variation.id}}"
                                                name="variations[]"
                                                value="{{variation.id}}"
                                            />
                                            <label
                                                class="form-check-label"
                                                for="{{variation.id}}"
                                            >
                                                <span class="font-weight-bold">{{variation.name}}</span>
                                                <span class="m-2"> + {{variation.price}} €</span>
                                            </label>
                                            <br />
                                        </div>

                                    </div>
                                    {% endfor %}
                                </div> -->
                            <div class="col-sm-12 col-md-6 col-xs-12">
                                <div class="pr-30 pl-30 detail-info">

                                    <div class="mb-30 short-desc">
                                        <p class="font-lg">{{product.description}}</p>
                                    </div>
                                    <div class="mb-50 detail-extralink">

                                        <div class="product-extra-link2">
                                            <div
                                                id="data"
                                                x-cloak
                                                x-data="{
                                                                        showModal: false,
                                                                        state: -1,
                                                                    }"
                                            >
                                                <form
                                                    action="#"
                                                    method="POST"
                                                    x-data="userManagement()"
                                                    class="max-h-screen overflow-auto"
                                                >
                                                    {%csrf_token%}
                                                    <input
                                                        type="hidden"
                                                        name="product"
                                                        value="{{product.id}}"
                                                    >
                                                    <div
                                                        x-show="showModal"
                                                        class="bg-black/50 fixed top-0 left-0 z-10 flex items-center justify-center w-full h-full max-h-screen overflow-auto"
                                                    >
                                                        <div
                                                            x-show="showModal"
                                                            x-transition
                                                            @keyup.escape.window="showModal = false"
                                                            @click.outside="showModal = false"
                                                            class="rounded-2xl relative z-20 max-h-screen p-8 overflow-auto bg-white"
                                                        >
                                                            <svg
                                                                xmlns="http://www.w3.org/2000/svg"
                                                                viewBox="0 0 16 16"
                                                                fill="currentColor"
                                                                @click="showModal=false"
                                                                class="top-2 right-2 size-12 absolute font-black text-green-600 cursor-pointer"
                                                            >
                                                                <path
                                                                    d="M5.28 4.22a.75.75 0 0 0-1.06 1.06L6.94 8l-2.72 2.72a.75.75 0 1 0 1.06 1.06L8 9.06l2.72 2.72a.75.75 0 1 0 1.06-1.06L9.06 8l2.72-2.72a.75.75 0 0 0-1.06-1.06L8 6.94 5.28 4.22Z"
                                                                />
                                                            </svg>
                                                            <div class="justify-center">
                                                                <h1
                                                                    class="h-min text-slate-600 max-w-2xl max-h-screen p-2 my-4 overflow-auto text-3xl font-bold"
                                                                    x-text="selectedUsers.length > 0? `Für: ${selectedUsers}`:``"
                                                                ></h1>
                                                                <!-- <h2 x-text="state"></h2> -->
                                                                <!-- <h3>{{variation_categories|length}}</h3> -->
                                                            </div>
                                                            <hr class="h-2 mx-auto my-5 rounded">
                                                            <!-- ? user -->
                                                            <div id="user">
                                                                <div
                                                                    id="user-1"
                                                                    x-show="state==-1"
                                                                >
                                                                    <h1
                                                                        class="text-slate-600 text-4xl font-bold text-center">
                                                                        Gruppenbestellung?</h1>
                                                                    <hr class="h-2 mx-auto my-5 rounded">
                                                                    <div class="flex justify-center my-6">
                                                                        <div
                                                                            class="text-slate-600 w-2/3 text-lg italic">
                                                                            Hier kannst für mehrere Personen
                                                                            gleichzeitig bestellen und für jeden
                                                                            einen Namen vergeben</div>
                                                                    </div>
                                                                </div>
                                                                <div
                                                                    id="user_0"
                                                                    x-transition
                                                                    x-show="state==0"
                                                                >
                                                                    <div>
                                                                        <div>
                                                                            <h2
                                                                                class="text-slate-600 text-2xl font-bold text-center">
                                                                                User auswählen</h2>
                                                                            <hr class="h-2 mx-auto my-5 rounded">
                                                                            <div
                                                                                class="flex items-center justify-between space-x-24">
                                                                                <div class="space-x-2">
                                                                                    <input
                                                                                        x-model="newUser"
                                                                                        @keydown.enter.prevent
                                                                                        @keyup.enter.prevent
                                                                                        @keydown.enter="addUser()"
                                                                                        type="text"
                                                                                        class="px-4 py-2 border-2 border-gray-500 rounded-lg"
                                                                                    >
                                                                                    <button
                                                                                        type="button"
                                                                                        @click="addUser()"
                                                                                        class="hover:border-green-600 hover:bg-green-400 px-4 py-2 my-3 text-white bg-green-600 border-2 border-green-200 rounded-lg"
                                                                                    >Hinzufügen</button>
                                                                                </div>
                                                                                <div
                                                                                    x-text="`Ausgewählt: ${selectedUsers.length}/${users.length}`"
                                                                                    class="text-xl text-gray-600"
                                                                                ></div>
                                                                            </div>
                                                                            <!-- # hidden input user data -->
                                                                            <div
                                                                                class="sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 alignment-center grid gap-3 m-8">
                                                                                <!-- <template x-if="selectedUsers.length > 0"> -->
                                                                                <input
                                                                                    type="hidden"
                                                                                    name="users"
                                                                                    :value="JSON.stringify(selectedUsers)"
                                                                                >
                                                                                <!-- </template> -->
                                                                                <template
                                                                                    x-for="(item, index) in paginatedUsers"
                                                                                    :key="(currentPage*1000)+index"
                                                                                >
                                                                                    <div
                                                                                        class="relative"
                                                                                        x-transition
                                                                                    >
                                                                                        <label>
                                                                                            <input
                                                                                                type="checkbox"
                                                                                                :value="item"
                                                                                                :checked="selectedUsers.includes(item)"
                                                                                                @change="toggleUser(item)"
                                                                                                class="peer/a hidden"
                                                                                                :id="(currentPage*1000)+index"
                                                                                            >
                                                                                            <div
                                                                                                class="peer-checked/a:bg-green-600 peer-checked/a:text-white flex items-center justify-center h-full p-8 text-2xl text-center text-green-600 bg-green-100 border border-green-600 rounded-lg">
                                                                                                <input
                                                                                                    type="checkbox"
                                                                                                    :value="item"
                                                                                                    :checked="selectedUsers.includes(item)"
                                                                                                    @change="toggleUser(item)"
                                                                                                    class="peer/a hidden"
                                                                                                    :id="(currentPage*1000)+index"
                                                                                                >
                                                                                                <span
                                                                                                    x-text="`${item}`"></span>
                                                                                                <!-- <span x-text="`| ${(currentPage*1000)+index}`"></span> -->
                                                                                            </div>
                                                                                        </label>
                                                                                        <svg
                                                                                            @click="deleteUser(item)"
                                                                                            class="top-1 right-1 size-6 absolute text-green-600 cursor-pointer"
                                                                                            :class="selectedUsers.includes(item) ? 'text-white' : 'text-green-600'"
                                                                                            xmlns="http://www.w3.org/2000/svg"
                                                                                            viewBox="0 0 16 16"
                                                                                            fill="currentColor"
                                                                                        >
                                                                                            <path
                                                                                                d="M5.28 4.22a.75.75 0 0 0-1.06 1.06L6.94 8l-2.72 2.72a.75.75 0 1 0 1.06 1.06L8 9.06l2.72 2.72a.75.75 0 1 0 1.06-1.06L9.06 8l2.72-2.72a.75.75 0 0 0-1.06-1.06L8 6.94 5.28 4.22Z"
                                                                                            />
                                                                                        </svg>
                                                                                    </div>
                                                                                </template>
                                                                            </div>
                                                                            <div
                                                                                x-show="totalPages > 1"
                                                                                id="showUser"
                                                                            >
                                                                                <hr class="my-5">
                                                                                <div
                                                                                    class="flex items-center justify-between">
                                                                                    <div
                                                                                        @click="prevPage()"
                                                                                        class="border-slate-600 hover:border-green-600 text-slate-600 hover:text-green-600 px-4 py-2 ml-5 border-2 rounded-lg cursor-pointer"
                                                                                        :disabled="currentPage === 1"
                                                                                        :class="{ 'text-white border-white hover:text-white hover:border-white': currentPage === 1 }"
                                                                                        x-text="`Seite ${currentPage-1}`"
                                                                                    ></div>
                                                                                    <span
                                                                                        x-text="`Seite ${currentPage} von ${totalPages}`"
                                                                                        class="text-slate-600 text-lg font-bold text-center"
                                                                                    ></span>
                                                                                    <div
                                                                                        x-text="`Seite ${currentPage+1}`"
                                                                                        @click="nextPage()"
                                                                                        :class="{'text-white border-white hover:text-white hover:border-white': currentPage === totalPages }"
                                                                                        class="border-slate-600 hover:border-green-600 text-slate-600 hover:text-green-600 px-4 py-2 ml-5 border-2 rounded-lg cursor-pointer"
                                                                                        :disabled="currentPage === totalPages"
                                                                                    ></div>
                                                                                </div>
                                                                                <hr class="my-5">
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                            </div>
                                                            {% for vc in variation_categories %}
                                                            <div
                                                                x-show="state=={{forloop.counter}}"
                                                                x-transition:enter-start="opacity-0 scale-90"
                                                                x-transition:enter="transition ease-out duration-300"
                                                                x-transition:enter-end="opacity-100 scale-100"
                                                            >
                                                                <h1
                                                                    class="mb-6 ml-8 text-2xl font-extrabold text-gray-700">
                                                                    name: {{vc.name}}
                                                                </h1>
                                                                <input
                                                                    type="hidden"
                                                                    name="variation_category"
                                                                    value="{{vc.id}}"
                                                                >
                                                                <div class="m-4">
                                                                    <div class="px-2 mx-2">
                                                                        <div
                                                                            class="justify-items-center place-items-center place-content-center sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 grid items-center content-center justify-center gap-4">
                                                                            {% for v in vc.variation_category.all %}
                                                                            <div
                                                                                class="rounded-xl max-h-screen overflow-hidden">
                                                                                <input
                                                                                    id="{{v.id}}"
                                                                                    name="variations"
                                                                                    value="{{v.id}}"
                                                                                    type="checkbox"
                                                                                    class="peer/a hidden"
                                                                                >
                                                                                <label
                                                                                    for="{{v.id}}"
                                                                                    class="peer-checked/a:border-4 peer-checked/a:border-green-600 rounded-xl flex overflow-hidden"
                                                                                >
                                                                                    <div class="relative w-32 h-24">
                                                                                        {% if v.image %}
                                                                                        <img
                                                                                            class="object-contain"
                                                                                            src="{{v.image.url}}"
                                                                                            alt="
                                                                                                                                                    no-image"
                                                                                        >
                                                                                        {% endif %}
                                                                                        <div
                                                                                            class="bg-black/40 rounded-xl absolute inset-0 object-contain">
                                                                                        </div>
                                                                                        <div
                                                                                            class="absolute inset-0 flex items-center justify-center mx-auto text-xl text-center text-white break-words">
                                                                                            <div>
                                                                                                <h3
                                                                                                    class="font-semibold">
                                                                                                    {{v.name}}
                                                                                                </h3>
                                                                                                {% if v.price != 0.00 %}
                                                                                                <h3 class="italic">
                                                                                                    +{{v.price}}
                                                                                                </h3>
                                                                                                {% endif %}
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                </label>
                                                                            </div>
                                                                            {% endfor %}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            {% endfor %}

                                                            <div
                                                                id="buttons"
                                                                class="flex items-center justify-between mx-10"
                                                            >
                                                                <div
                                                                    @click="state===-1? state++ : state--"
                                                                    x-text="state===-1 ? `Ja` : `Zurück`"
                                                                    class="hover:border-green-600 hover:bg-green-400 px-4 py-2 ml-5 text-white bg-green-500 border-2 border-green-200 rounded-lg cursor-pointer"
                                                                ></div>
                                                                <h2
                                                                    class="mx-4 text-xl font-bold text-gray-600"
                                                                    x-text="`${state+1}/${ {{variation_categories|length}} +1}`"
                                                                ></h2>
                                                                <div
                                                                    @click="state===-1 ? state+=2 : state++"
                                                                    x-text="state===-1 ? `Nein`: `Weiter`"
                                                                    class="hover:border-green-600 hover:bg-green-400 px-4 py-2 ml-5 text-white bg-green-500 border-2 border-green-200 rounded-lg cursor-pointer"
                                                                    :class="{'hidden':state >= {{variation_categories|length}}, 'bg-gray-500 cursor-not-allowed' : state===-1}"
                                                                ></div>
                                                                <div
                                                                    type="submit"
                                                                    x-show="state >= {{variation_categories|length}}"
                                                                    class="hover:border-green-600 hover:bg-green-400 px-4 py-2 ml-5 text-white bg-green-500 border-2 border-green-200 rounded-lg cursor-pointer"
                                                                >Warenkorb</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </form>
                                                <button
                                                    @click="showModal = true"
                                                    type="submit"
                                                    id="add-button"
                                                    class="button-add-to-cart button"
                                                >zusammenstellen</button>
                                            </div>
                                            <script>
                                                function userManagement() {
                                                    console.log('test');
                                                    return {
                                                        newUser: '',
                                                        users: [],
                                                        currentPage: 1,
                                                        usersPerPage: 6,
                                                        paginatedUsers: [],
                                                        selectedUsers: [],

                                                        init() {
                                                            this.loadUsersFromCookie();
                                                            this.updatePaginatedUsers();
                                                        },
                                                        // chceckbox
                                                        toggleUser(user) {
                                                            const index = this.selectedUsers.indexOf(user);
                                                            if (index === -1) {
                                                                this.selectedUsers.push(user);
                                                            } else {
                                                                this.selectedUsers.splice(index, 1);
                                                            }
                                                        },
                                                        selectCheckbox(event) {
                                                            if (event.target.checked) {
                                                                this.selectedCheckboxes.push(event.target.value);
                                                            } else {
                                                                const index = this.selectedCheckboxes.indexOf(event.target.value);
                                                                if (index > -1) {
                                                                    this.selectedCheckboxes.splice(index, 1);
                                                                }
                                                            }
                                                        },

                                                        updateSelectedCheckboxes() {
                                                            const currentPageItems = this.paginatedUsers.map(item => item.toString());
                                                            this.selectedCheckboxes = this.selectedCheckboxes.filter(value => currentPageItems.includes(value));
                                                        },
                                                        //@ create and delete
                                                        addUser() {
                                                            if (this.newUser.trim() !== '') {
                                                                this.users.push(this.newUser);
                                                                this.saveUsersToCookie();
                                                                this.newUser = '';
                                                                this.updatePagination();
                                                                this.updatePaginatedUsers();
                                                                this.saveUsersToCookie();
                                                            }
                                                        },
                                                        deleteUser(item) {
                                                            const usersIndex = this.users.indexOf(item);
                                                            console.log("usersIndex", usersIndex);
                                                            const selectedUsersIndex = this.selectedUsers.indexOf(item);
                                                            console.log("selectedUsersIndex", selectedUsersIndex);
                                                            this.users.splice(usersIndex, 1);
                                                            this.selectedUsers.splice(selectedUsersIndex, 1);
                                                            this.saveUsersToCookie();
                                                            this.updatePagination();
                                                            this.updatePaginatedUsers();
                                                            this.saveUsersToCookie();
                                                        },
                                                        // save and load
                                                        loadUsersFromCookie() {
                                                            const cookieUsers = this.getCookie('users');
                                                            if (cookieUsers) {
                                                                this.users = JSON.parse(cookieUsers);
                                                            }
                                                            this.updatePagination();
                                                            this.updatePaginatedUsers();
                                                        },

                                                        saveUsersToCookie() {
                                                            this.setCookie('users', JSON.stringify(this.users), 30);
                                                        },
                                                        // set and get cookie
                                                        setCookie(name, value, days) {
                                                            const date = new Date();
                                                            date.setTime(date.getTime() + (days * 365 * 24 * 60 * 60 * 1000));
                                                            const expires = "expires=" + date.toUTCString();
                                                            document.cookie = name + "=" + value + ";" + expires + ";path=/";
                                                        },

                                                        getCookie(name) {
                                                            const cookieName = name + "=";
                                                            const decodedCookie = decodeURIComponent(document.cookie);
                                                            const cookieArray = decodedCookie.split(';');
                                                            for (let i = 0; i < cookieArray.length; i++) {
                                                                let cookie = cookieArray[i];
                                                                while (cookie.charAt(0) === ' ') {
                                                                    cookie = cookie.substring(1);
                                                                }
                                                                if (cookie.indexOf(cookieName) === 0) {
                                                                    return cookie.substring(cookieName.length, cookie.length);
                                                                }
                                                            }
                                                            return "";
                                                        },
                                                        // page length
                                                        get totalPages() {
                                                            console.log(Math.ceil(this.users.length / this.usersPerPage));
                                                            return Math.ceil(this.users.length / this.usersPerPage);
                                                        },

                                                        // pagination function
                                                        updatePaginatedUsers() {
                                                            const start = (this.currentPage - 1) * this.usersPerPage;
                                                            const end = start + this.usersPerPage;
                                                            this.paginatedUsers = this.users.slice(start, end);
                                                            //console.log("paginatedUsers", this.paginatedUsers.length);
                                                        },

                                                        nextPage() {
                                                            if (this.currentPage < this.totalPages) {
                                                                this.currentPage++;
                                                                this.updatePaginatedUsers();
                                                            }
                                                        },

                                                        prevPage() {
                                                            if (this.currentPage > 1) {
                                                                this.currentPage--;
                                                                this.updatePaginatedUsers();
                                                            }
                                                        },

                                                        updatePagination() {
                                                            if (this.currentPage > this.totalPages) {
                                                                this.currentPage = this.totalPages || 1;
                                                            }
                                                            this.updatePaginatedUsers();
                                                        },
                                                    }
                                                }
                                            </script>
                                        </div>
                                    </div>
                                </div>
                                <!-- Detail Info -->
                            </div>
                        </div>
                    </div>

                    <div class="sticky-sidebar mt-30 col-xl-3 primary-sidebar">
                        <div class="mb-30 sidebar-widget widget-category-2">
                            <h5 class="mb-30 section-title style-1">Andere Kategorien</h5>
                            <ul>
                                {% for category in all_categories %}

                                <li>
                                    <a href="{% url 'category' category.id %}"> <img
                                            src="{% url 'category' product.category.id%}"
                                            alt=""
                                        />{{category.name}}</a><span class="count">30</span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

</main>

{% endblock body %}
{% block statics %}
{{block.super}}
<script src="https://cdn.tailwindcss.com"></script>
<script
    defer
    src="https://unpkg.com/alpinejs"
></script>
{% endblock statics %}