{% extends 'p1/base.html' %}
{% load static %}
{% block title %}Bestellung{% endblock %}

{% block main %}
<script src="{% static 'mina/persist.min.js'%}"></script>
<main class=" flex flex-col items-center py-12 mx-auto">
    <form
        x-data="{
            p_phone: $persist(''),
            time: '',
            term: $persist(false),
            warn: false,
            accordion: $persist(false),
            company_name: $persist(''),
            company_address: $persist(''),
            company_zip: $persist(''),
            company_city: $persist(''),
            company_ust: $persist(''),
            init(){
                const now = new Date()
                this.time = `${now.getHours()}:${now.getMinutes()}`
            },
            check(){
                const hours = this.time.split(':')[0];
                if(hours < 7 || hours > 19){
                    this.warn = true;
                    this.time = '';
                } else{
                    this.warn = false;
                }
            }
        }"
        action="{%url 'order'%}"
        method="POST"
        class="sm:w-9/12 bg-gray-50 md:w-6/12 rounded-xl w-11/12 p-4 space-y-6 text-gray-600 border-2 border-gray-300"
        @submit.prevent="console.log('submitted!')"
    >
        {%csrf_token%}
        <div class="space-y-2">
            <h1 class="mb-5 text-4xl font-bold text-center text-gray-700">Bestellung</h1>
            <h3 class="text-xl text-center text-gray-500">Sie brauchen keine Anmeldung, wir k√ºmmern uns um alles üòâ</h3>
        </div>
        <h2 class="mb-5 text-xl text-green-500">Wann m√∂chten sie es abholen?</h2>
        <h3 class="text-md animate-pulse w-5/6 mb-5 text-gray-500">Optional, k√∂nnen Sie uns Ihre Nummer geben, damit
            wir sie
            bez√ºglich Ihrer Bestellung erreichen k√∂nnen</h3>
        <hr class="border-gray-400">
        <div class="space-x-2">
            <div class="flex gap-3">
                <input
                    :value="time"
                    @change="check()"
                    x-model="time"
                    type="time"
                    name="time"
                    id="time"
                    required
                    class="p-2 text-xl text-white bg-green-400 rounded-lg shadow-xl"
                >
                <input
                    x-model="p_phone"
                    type="tel"
                    name="p_phone"
                    id="p_phone"
                    placeholder="017610000080*"
                    class="w-full p-2 text-xl border-2 border-gray-300 rounded-lg"
                >
            </div>
            <template x-if="warn">
                <div class="font-bold text-gray-500">Bestellungen sind nur innerhalb von 07:00 - 20:00 m√∂glich</div>
            </template>
        </div>
        <h2 class="text-xl text-green-500">Sie erhalten die Rechnung per Mail, wie von Zauberhand ü™Ñ </h2>
        <hr class="border-gray-400">

        <br>
        <div class="rounded-xl w-full overflow-hidden bg-white shadow-lg">
            <div class="">
                <button
                    class="hover:bg-green-600 flex justify-between w-full p-8 text-white transition-colors duration-300 ease-in-out bg-green-400 cursor-pointer"
                    @click="accordion !== false ? accordion = false : accordion = true"
                >
                    <span class="text-2xl font-bold">Sind Sie ein Unternehmer?</span>
                    <!-- Chevron Down -->
                    <div>
                        <svg
                            :class="accordion == true ? 'hidden' : 'block-inline'"
                            xmlns="http://www.w3.org/2000/svg"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke-width="1.5"
                            stroke="currentColor"
                            class="size-8"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                d="M19.5 8.25l-7.5 7.5-7.5-7.5"
                            />
                        </svg>
                        <!-- Chevron Up -->
                        <svg
                            :class="accordion == true ? 'block-inline' : 'hidden'"
                            xmlns="http://www.w3.org/2000/svg"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke-width="1.5"
                            stroke="currentColor"
                            class="size-8"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                d="M4.5 15.75l7.5-7.5 7.5 7.5"
                            />
                        </svg>
                    </div>
                </button>
                <div
                    class="max-h-0 space-y-4 overflow-hidden transition-all duration-500 ease-in-out"
                    x-ref="r1"
                    :style="accordion == true ? 'max-height: '+ $refs.r1.scrollHeight + 'px' : '' "
                >
                    <div class="text-bold mx-6 my-4 text-xl text-gray-600">Damit es steuerlich richtig
                        abgef√ºhrt wird,
                        brauchen
                        wir die Unternehmensdaten</div>
                    <div class="text-md animate-pulse w-5/6 mx-6 my-4 text-gray-500">einmal schreiben und
                        es ist
                        sofort
                        gespeichert</div>
                    <div
                        class="place-items-start sm:place-items-center sm:grid-cols-2 grid grid-cols-1 gap-3 py-6 mx-6 my-4">
                        <label for="company-name"> Name:
                        </label>
                        <input
                            id="company_name"
                            name="company_name"
                            x-model="company_name"
                            type="text"
                            class="p-2 border rounded-md"
                        >
                        <label for="company_address"> Anschrift:
                        </label>
                        <input
                            id="company_address"
                            name="company_address"
                            x-model="company_address"
                            type="text"
                            class="p-2 border rounded-md"
                        >
                        <label for="company-zip"> PLZ:
                        </label>
                        <input
                            id="company_zip"
                            name="company_zip"
                            x-model="company_zip"
                            type="text"
                            class="p-2 border rounded-md"
                        >
                        <label for="company-city"> Ort:
                        </label>
                        <input
                            id="company_city"
                            name="company_city"
                            x-model="company_city"
                            type="text"
                            class="p-2 border rounded-md"
                        >
                        <label for="company-ust"> Ust-ID:
                        </label>
                        <input
                            id="company_ust"
                            name="company_ust"
                            x-model="company_ust"
                            type="text"
                            class="p-2 border rounded-md"
                        >
                    </div>
                </div>
            </div>
        </div>
        <label
            for="term"
            class="flex space-x-2 text-gray-500"
        >
            <input
                type="checkbox"
                id="term"
                name="term"
                x-model="term"
                class="accent-green-400"
                required
                x-init="$nextTick(() => { f1(); });"
            >
            <h3 class="text-md text-gray-500"> Ich akzeptiere die <span><a
                        href="{% url 'agb' %}"
                        class="text-green-700 underline"
                    >Nutzungsbedingungen & AGB</a></span>
            </h3>
        </label>
        <script>
            function f1() {
                const checkbox = document.getElementById('term');
                //console.log(checkbox.checked.toString());
            }</script>
        <div
            id="paypal-button-container"
            :class="{'pointer-events-none opacity-50' : term==false || time.length == 0 }"
        >
            <script
                src="https://www.paypal.com/sdk/js?client-id=AfI1HwjRFulrVZuJ1HXjQgGUxEixc-oggTBfdycCrML47plbdt9AY5pVNSnPOKHrcTLLZvqTxYJlLELY&currency=EUR"
            ></script>
            <script>
                brutto = '{{brutto}}'.replace(",", ".");
                const formData = {
                    pickupTime: document.getElementById('time').value,
                    phone: document.getElementById('p_phone').value,
                    term: document.getElementById('term').checked.toString(),
                    companyName: document.getElementById('company_name').value,
                    companyAddress: document.getElementById('company_address').value,
                    companyZip: document.getElementById('company_zip').value,
                    companyCity: document.getElementById('company_city').value,
                    companyUst: document.getElementById('company_ust').value
                };
                console.log(formData)

                paypal.Buttons({
                    createOrder: (data, actions) => {
                        return actions.order.create({
                            purchase_units: [{
                                amount: {
                                    value: brutto // Set your payment amount here
                                }
                            }]
                        });
                    },
                    onApprove: (data, actions) => {
                        return actions.order.capture().then((details) => {
                            const transactionData = {
                                // Order details
                                orderID: data.orderID,
                                id: details.id,
                                status: details.status,
                                intent: details.intent,
                                create_time: details.create_time,
                                update_time: details.update_time,

                                // Payer information
                                payer: {
                                    name: {
                                        given_name: details.payer.name.given_name,
                                        surname: details.payer.name.surname
                                    },
                                    email_address: details.payer.email_address,
                                    payer_id: details.payer.payer_id,
                                    address: details.payer.address,
                                    phone: details.payer.phone ? {
                                        phone_type: details.payer.phone.phone_type,
                                        phone_number: details.payer.phone.phone_number
                                    } : null
                                },

                                // Purchase units
                                purchase_units: details.purchase_units.map(unit => ({
                                    reference_id: unit.reference_id,
                                    amount: {
                                        currency_code: unit.amount.currency_code,
                                        value: unit.amount.value,
                                        breakdown: unit.amount.breakdown
                                    },
                                    payee: unit.payee,
                                    shipping: unit.shipping ? {
                                        name: unit.shipping.name,
                                        address: unit.shipping.address
                                    } : null,
                                    payments: unit.payments ? {
                                        captures: unit.payments.captures,
                                        authorizations: unit.payments.authorizations,
                                        refunds: unit.payments.refunds
                                    } : null,
                                    items: unit.items
                                })),

                                // Payment source
                                payment_source: details.payment_source,

                                // Links
                                links: details.links,

                                // Additional fields that might be available
                                gross_amount: details.gross_amount,
                                seller_protection: details.seller_protection,
                                soft_descriptor: details.soft_descriptor,
                                invoice_id: details.invoice_id,
                                custom_id: details.custom_id,
                                application_context: details.application_context
                            };
                            const formData = {
                                pickupTime: document.getElementById('time').value,
                                phone: document.getElementById('p_phone').value,
                                term: document.getElementById('term').checked.toString(),
                                companyName: document.getElementById('company_name').value,
                                companyAddress: document.getElementById('company_address').value,
                                companyZip: document.getElementById('company_zip').value,
                                companyCity: document.getElementById('company_city').value,
                                companyUst: document.getElementById('company_ust').value
                            };
                            console.log('Transaction completed by ' + details.payer.name.given_name);
                            console.log('Transaction ID: ' + details.id);
                            console.log('Full transaction details:', JSON.stringify(transactionData, null, 2));
                            // Collect form data
                            fetch('{% url "order"%}', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token }}'
                                },
                                body: JSON.stringify({
                                    transactionData: transactionData,
                                    formData: formData,
                                }),
                            }).then(response => response.json())
                                .then(result => {
                                    if (result.success) {
                                        console.log('ok')
                                        window.location.href = "{% url 'success' %}";
                                    } else {
                                        console.log('error')
                                        window.location.href = "{% url 'failed' %}";
                                    }
                                });
                            // Combine PayPal details and form data
                            // const postData = {
                            //     paypalDetails: details,
                            //     formData: formData
                            // };

                            // Create a form element
                            // const form = document.createElement('form');
                            // form.method = 'POST';
                            // form.action = "{% url 'order' %}";

                            // Create input for CSRF token
                            // const csrfInput = document.createElement('input');
                            // csrfInput.type = 'hidden';
                            // csrfInput.name = 'csrfmiddlewaretoken';
                            // csrfInput.value = '{% csrf_token %}';
                            // form.appendChild(csrfInput);

                            // Create input for data
                            // const dataInput = document.createElement('input');
                            // dataInput.type = 'hidden';
                            // dataInput.name = 'data';
                            // dataInput.value = JSON.stringify(postData);
                            // form.appendChild(dataInput);

                            // Append form to body, submit it, and remove it
                            // document.body.appendChild(form);
                            // form.submit();
                            // document.body.removeChild(form);
                        });
                    },
                    onError: (err) => {
                        console.error('An error occurred during the transaction', err);
                        //window.location.href = "{% url 'failed' %}"; // Redirect to failed page
                    }
                }).render('#paypal-button-container'); // Display PayPal button
            </script>
        </div>
    </form>
</main>

{% endblock %}